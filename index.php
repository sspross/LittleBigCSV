<?php/* SETTINGS (PLEASE CHANGE) --------------------------- */$settings = array(	'db_host'		=> 'localhost',	'db_user'		=> 'user',	'db_password'	=> 'pass',	'db_database'	=> 'database',	'tbl_prefix'	=> 'cvs',	'dir_base'		=> '/home/cust/blabla/public_html/cvs/',);/* USERS (PLEASE CHANGE)------------------------ */$users = array(	array('user' => 'hans', 'pass' => 'hans'),	array('user' => 'peter', 'pass' => 'peter'),);/* SOURCE (please DON'T change!)-------------------------------- *//* Initialisierung------------------ */$source_folder = $settings["dir_base"]."source/";$user_folder = $settings["dir_base"]."users/";$versions_folder = $settings["dir_base"]."versions/";$request = $_GET["dir"];$request_dirs = explode("/",$request);/* DB kontaktieren------------------ */$conn = mysql_connect($settings["db_host"],$settings["db_user"],$settings["db_password"]) OR DIE ("DB Verbindung fehlgeschlagen");mysql_select_db($settings["db_database"],$conn) OR DIE ("Konnte DB nicht waehlen");/* Begin-------- */session_start();/* Build source folder variable------------------------------- */if ($_GET["view"] == "myfiles") {		$read_folder = $user_folder.$_SESSION["user"]["user"]."/";} else {	$read_folder = $source_folder;}switch ($_GET["do"]) {	case "logout":		unset($_SESSION["user"]);		break;	case "checkout":		$files2checkout = $_POST["checkout"];		for($i=0;$i<count($files2checkout);$i++) {			shell_exec("ln ".$read_folder.$files2checkout[$i]." ".$user_folder.$_SESSION["user"]["user"]."/".$files2checkout[$i]);			$res = mysql_query("UPDATE ".$settings["tbl_prefix"]."_files SET checker = '".$_SESSION["user"]["user"]."' WHERE location = '".$files2checkout[$i]."'",$conn);			$row = mysql_fetch_array(mysql_query("SELECT * FROM ".$settings["tbl_prefix"]."_files WHERE location = '".$files2checkout[$i]."'",$conn),MYSQL_ASSOC);			shell_exec("cp -r ".$read_folder.$files2checkout[$i]." ".$versions_folder.$row["id"]."_".time());		}		break;	case "checkin":		$files2checkin = $_POST["checkout"];		for($i=0;$i<count($files2checkin);$i++) {			shell_exec("rm -r ".$read_folder.$files2checkin[$i]);			$res = mysql_query("UPDATE ".$settings["tbl_prefix"]."_files SET checker = '', date = '".time()."' WHERE location = '".$files2checkin[$i]."'",$conn);		}		break;	case "checkallin":		$res = mysql_query("SELECT * FROM ".$settings["tbl_prefix"]."_files WHERE checker = '".$_SESSION["user"]["user"]."'",$conn);		$num = mysql_num_rows($res); 		if ($num > 0) { 			for($i=0; $i<$num; $i++) {				$location = mysql_result($res,$i,"location");				shell_exec("rm -r ".$read_folder.$location);			}		}		$res = mysql_query("UPDATE ".$settings["tbl_prefix"]."_files SET checker = '', date = '".time()."' WHERE checker = '".$_SESSION["user"]["user"]."'",$conn);				break;	case "checkinfirsttime":		$string = explode("/",$_GET["file"]);		$last = count($string) - 1;		$file = $string[$last];		unset($string[$last]);				for($i=0;$i<count($string);$i++) {			if ($check) {				$check = $check."/".$string[$i];			} else {				$check = $string[$i];			}			if (!file_exists($source_folder.$check)) {				shell_exec("mkdir ".$source_folder.$check);			}		}				shell_exec("mv ".$user_folder.$_SESSION["user"]["user"]."/".$_GET["file"]." ".$source_folder.$_GET["file"]);		mysql_query("INSERT INTO ".$settings["tbl_prefix"]."_files (location,date,description) VALUES ('".$_GET["file"]."','".time()."','init from ".$_SESSION["user"]["user"]."')",$conn);		break;	case "viewsource":		$viewsource = true;		break;	case "editsource":		$editsource = true;		break;	case "savesource":		$file = $source_folder.$_POST["file"];		$inhalt = $_POST["inhalt"];		$handle = fopen($file,"w");		fwrite($handle,$inhalt);		fclose($handle);		break;	case "list":		$list = true;		break;}if (!isset($_SESSION["user"])) {	if ($_POST["user"] != "" && $_POST["pass"] != "") {		$found = false;		for ($i=0;$i<count($users);$i++) {			if ($_POST["user"] == $users[$i]["user"] && $_POST["pass"] == $users[$i]["pass"]) {				$_SESSION["user"] = $users[$i];				$found = true;			}		}		if ($found) {			header("Location: index.php");		} else {			echo "User not found!";		}	} else {		?>		<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">				<html>					<head>				<title>CVS Login</title>				<link href="utils/default.css" rel="stylesheet" type="text/css" media="all">			</head>					<body bgcolor="#99cc66">				<table width="100%" border="0" cellspacing="0" cellpadding="0" height="80%">					<form id="FormLogin" action="index.php" method="post" name="FormLogin">					<tr>						<td align="center" valign="middle">							<p><b>LittleBigCVS 0.1b</b></p>							<table width="245" border="0" cellspacing="0" cellpadding="2">								<tr>									<td width="118">Username:</td>									<td><input type="text" name="user" size="24"></td>								</tr>								<tr>									<td width="118">Password:</td>									<td><input type="password" name="pass" size="24"></td>								</tr>								<tr>									<td width="118"></td>									<td><input type="submit" name="submitButtonName" value="login"></td>								</tr>							</table>						</td>					</tr>					</form>				</table>			</body>				</html>		<?php	}	} else {	/* Build folders and subfolders for online user if not exist	------------------------------------------------------------ */	if (!file_exists($user_folder.$_SESSION["user"]["user"]."/".$request)) {		shell_exec("mkdir ".$user_folder.$_SESSION["user"]["user"]."/".$request);	}	/* Darstellung	-------------- */	?>	<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">		<html>			<head>			<title>CVS</title>			<link href="utils/default.css" rel="stylesheet" type="text/css" media="all">		</head>		<?php			if ($_GET["view"] == "myfiles") {					echo "<body bgcolor=\"#33cccc\">";			} else {				echo "<body bgcolor=\"#99cc66\">";			}	?>				<table width="100%" border="0" cellspacing="0" cellpadding="2">					<tr>						<td align="left" width="30%"><b><?php echo "Location: /".$request; ?></b></td>						<td align="center" width="40%"><?php							if ($_GET["view"] == "myfiles") {							?><a href="index.php">project files</a> | <b>my files</b><?php							} else {							?><b>project files</b> | <a href="index.php?view=myfiles">my files</a><?php							}							?>						</td>						<td align="right" width="30%"><?php echo "<b>".$_SESSION["user"]["user"]; ?></b> | <a href="index.php?do=logout">logout</a></td>					</tr>				</table>				<hr noshade size="1">				<table width="100%" border="0" cellspacing="0" cellpadding="2">				<?php					if ($_GET["view"] == "myfiles") {							echo "<form id=\"FormCheckin\" action=\"index.php?view=myfiles&do=checkin&dir=".$request."\" method=\"post\" name=\"FormCheckin\">";					} else {						echo "<form id=\"FormCheckout\" action=\"index.php?do=checkout&dir=".$request."\" method=\"post\" name=\"FormCheckout\">";					}				?>					<tr>						<td align="left" width="30%">						<?php							if ($_GET["view"] == "myfiles") {									echo "<input type=\"submit\" name=\"submitButtonName\" value=\"check selected in\"> ";								echo "<input type=\"button\" name=\"submitButtonName\" value=\"check ALL in\" onclick=\"window.location.href = 'index.php?view=myfiles&do=checkallin'\"> ";							} else {								echo "<input type=\"submit\" name=\"submitButtonName\" value=\"check selected out\"> ";							}						?>						</td>						<td align="center" width="40%"></td>						<td align="right" width="30%">												<?php												for($i=0;$i<count($users);$i++) {							$res = mysql_query("SELECT * FROM ".$settings["tbl_prefix"]."_files WHERE checker = '".$users[$i]["user"]."'",$conn);							$num = mysql_num_rows($res);							if ($_GET["view"] == "myfiles") {								echo "<a href=\"index.php?do=list&user=".$users[$i]["user"]."&view=myfiles&dir=".$request."\">".$users[$i]["user"]." (".$num.")</a>";							} else {								echo "<a href=\"index.php?do=list&user=".$users[$i]["user"]."&dir=".$request."\">".$users[$i]["user"]." (".$num.")</a>";							}							if ($i != (count($users) - 1)) {								echo ", ";							};						}												?>												</td>					</tr>				</table>				<?php				if ($list) {				?>				<hr noshade size="1">				<table width="100%" border="0" cellspacing="1" cellpadding="2">					<tr>						<td width="30"></td>						<td width="30"></td>						<td colspan="3"><b><?php echo $_GET["user"]; ?> checked out:</b></td>					</tr>					<?php					$res = mysql_query("SELECT * FROM ".$settings["tbl_prefix"]."_files WHERE checker = '".$_GET["user"]."'",$conn);					$num = mysql_num_rows($res);					if ($num > 0) {						for ($i=0;$i<$num;$i++) {							$location = mysql_result($res,$i,"location");					?>					<tr height="20">						<td height="20" width="30"><input type="checkbox" name="checkout[]" value="<?php echo $request.$files[$i]; ?>" disabled></td>						<td height="20" width="30"><img src="utils/file.gif" alt="" width="16" height="16" border="0"></td>						<td height="20" class="bg" colspan="3"><?php echo $location; ?></td>					</tr>					<?php						}					} else {					?>					<tr>						<td width="30"></td>						<td width="30"></td>						<td colspan="3">no files found</td>					</tr>					<?php					}					?>				</table>				<?php				}				?>				<hr noshade size="1">				<table width="100%" border="0" cellspacing="1" cellpadding="2">					<tr height="10">						<td height="10" colspan="5"></td>					</tr>					<tr>						<td width="30" colspan="2"></td>						<td colspan="3"><b>Folder</b></td>					</tr>	<?php				/* Create Tables if not exist		----------------------------- */		$query = "CREATE TABLE IF NOT EXISTS `".$settings["tbl_prefix"]."_files` (			`id` int(11) NOT NULL auto_increment,			`checker` text NOT NULL,			`location` text NOT NULL,			`date` text NOT NULL,			`description` text NOT NULL,			UNIQUE KEY `id` (`id`)		) TYPE=MyISAM AUTO_INCREMENT=5;";		$res = mysql_query($query,$conn);				/* Files auslesen und sortieren		------------------------------- */		$ls = shell_exec("ls -AF ".$read_folder.$request);		$ls = explode("\n",$ls);		for($i=0;$i<count($ls);$i++) {			if (strstr($ls[$i],"/")) {				if ($ls[$i] != "") {					$dirs[] = $ls[$i];				}			} else {				if ($ls[$i] != "") {					$files[] = $ls[$i];					if ($_GET["view"] != "myfiles") {						$res = mysql_num_rows(mysql_query("SELECT * FROM ".$settings["tbl_prefix"]."_files WHERE location = '".$request.$ls[$i]."'",$conn));						if ($res < 1) {							mysql_query("INSERT INTO ".$settings["tbl_prefix"]."_files (location,date,description) VALUES ('".$request.$ls[$i]."','".time()."','init')",$conn);						}					}				}			}		}		if ($dirs) { sort($dirs); };		if ($files) { sort($files); };					if (count($request_dirs) > 1) {		?>							<tr height="20">						<td height="20" width="30"></td>						<td height="20" width="30"><img src="utils/folder.gif" alt="" width="16" height="16" border="0"></td>						<td height="20" class="bg" colspan="3">		<?php			if ($_GET["view"] == "myfiles") {					echo "<a href=\"index.php?view=myfiles&dir=";			} else {				echo "<a href=\"index.php?dir=";			}			for($i=0;$i<(count($request_dirs)-2);$i++) {				echo $request_dirs[$i]."/";			}			echo "\">../</a><br>";		?>						</td>					</tr>		<?php		}				for($i=0;$i<count($dirs);$i++) {		?>					<tr height="20">						<td height="20" width="30"></td>						<td height="20" width="30"><img src="utils/folder.gif" alt="" width="16" height="16" border="0"></td>						<td height="20" class="bg" colspan="3">		<?php 			if ($_GET["view"] == "myfiles") {					echo "<a href=\"index.php?view=myfiles&dir=".$request.$dirs[$i]."\">".$dirs[$i]."</a><br>";			} else {				echo "<a href=\"index.php?dir=".$request.$dirs[$i]."\">".$dirs[$i]."</a><br>";			}					?>						</td>					</tr>					<?php		}				?>				<tr height="10">						<td height="10" colspan="5"></td>					</tr>		<?php 			if ($_GET["view"] == "myfiles") {			?>					<tr>						<td width="30" colspan="2"></td>						<td><b>Filename</b></td>						<td width="170"><b></b></td>						<td width="170"><b></b></td>					</tr>		<?php			} else {		?>					<tr>						<td width="30" colspan="2"></td>						<td><b>Filename</b></td>						<td width="170"><b>Since</b></td>						<td width="170"><b>Beeing used by</b></td>					</tr>		<?php			}				if (count($files) > 0) {					for($i=0;$i<count($files);$i++) {				$res = mysql_query("SELECT * FROM ".$settings["tbl_prefix"]."_files WHERE location = '".$request.$files[$i]."'",$conn);				$row = mysql_fetch_array($res,MYSQL_ASSOC);											if ($_GET["view"] == "myfiles") {				?>							<tr height="20">							<td height="20" width="30"><?php if (mysql_num_rows($res) > 0) { ?><input type="checkbox" name="checkout[]" value="<?php echo $request.$files[$i]; ?>"><?php } else { ?><input type="checkbox" name="checkout[]" value="<?php echo $request.$files[$i]; ?>" disabled><?php } ?></td>							<td height="20" width="30"><img src="utils/file.gif" alt="" width="16" height="16" border="0"></td>							<td height="20" class="bg"><a href="index.php?view=myfiles&do=editsource&file=<?php echo $request.$files[$i]; ?>&dir=<?php echo $request; ?>"><?php echo $files[$i]."<br>"; ?></a></td>							<td height="20" width="170" class="bg"><?php if (mysql_num_rows($res) <= 0) { ?><input type="button" name="submitButtonName" value="check in first time" onclick="window.location.href = 'index.php?view=myfiles&do=checkinfirsttime&file=<?php echo $request.$files[$i]; ?>&dir=<?php echo $request; ?>'"><?php } ?></td>							<td height="20" width="170" class="bg"></td>						</tr>			<?php			} else {			?>						<tr height="20">							<td height="20" width="30"><?php if (!$row["checker"]) { ?><input type="checkbox" name="checkout[]" value="<?php echo $request.$files[$i]; ?>"><?php } else { ?><input type="checkbox" name="checkout[]" value="<?php echo $request.$files[$i]; ?>" disabled><?php } ?></td>							<td height="20" width="30"><img src="utils/file.gif" alt="" width="16" height="16" border="0"></td>							<td height="20" class="bg"><a href="index.php?do=viewsource&file=<?php echo $request.$files[$i]; ?>&dir=<?php echo $request; ?>"><?php echo $files[$i]."<br>"; ?></a></td>							<td height="20" width="170" class="bg"><?php echo date("d.m.Y | H:i",$row["date"]); ?></td>							<td height="20" width="170" class="bg"><?php if ($row["checker"]) { echo $row["checker"]; } else { echo "-"; } ?></td>						</tr>			<?php			}			}					} else {		?>					<tr>						<td width="30"></td>						<td width="30"></td>						<td colspan="3">no files in this folder</td>					</tr>		<?php		}				?>					<tr>						<td height="15" colspan="5"></td>					</tr>					</form>			</table>		<?php		if ($viewsource) {		?>			<hr noshade size="1">			<table width="100%" border="0" cellspacing="0" cellpadding="2">				<tr>					<td align="left"><?php highlight_file($source_folder.$_GET["file"]); ?></td>				</tr>			</table>		<?php		}		if ($editsource) {		?>			<hr noshade size="1">			<table width="100%" border="0" cellspacing="1" cellpadding="2">				<form id="FormEdit" action="index.php?do=savesource&view=myfiles&dir=<?php echo $request; ?>" method="post" name="FormEdit">				<tr>					<td align="center"><textarea name="inhalt" rows="52" cols="100" wrap="off"><?php					$file = file($user_folder.$_SESSION["user"]["user"]."/".$_GET["file"]);					for ($i=0;$i<count($file);$i++) {						echo $file[$i];					}					?>					</textarea><input type="hidden" name="file" value="<?php echo $_GET["file"]; ?>"></td>				</tr>				<tr>					<td align="center"><input type="submit" name="submitButtonName" value="save"></td>				</tr>				</form>			</table>		<?php		}		?>			<hr noshade size="1">			<table width="100%" border="0" cellspacing="0" cellpadding="2">				<tr>					<td align="left" width="30%"></td>					<td align="center" width="40%">LittleBigCVS 0.1b</td>					<td align="right" width="30%"></td>				</tr>			</table>		</body>	</html>	<?php	}?>